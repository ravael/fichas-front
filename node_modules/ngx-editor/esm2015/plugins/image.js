import { NodeSelection, Plugin, PluginKey } from 'prosemirror-state';
const WRAPPER_CLASSNAME = 'NgxEditor__ImageWrapper';
const WRAPPER_RESIZE_ACTIVE_CLASSNAME = 'NgxEditor__Resizer--Active';
const RESIZE_HANDLE_CLASSNAME = 'NgxEditor__ResizeHandle';
const createHandle = (direction) => {
    const handle = document.createElement('span');
    handle.className = `${RESIZE_HANDLE_CLASSNAME}--${direction}`;
    return handle;
};
const ɵ0 = createHandle;
class ImageRezieView {
    constructor(node, view, getPos) {
        var _a, _b;
        const outer = document.createElement('span');
        outer.className = WRAPPER_CLASSNAME;
        outer.style.width = node.attrs.width;
        const handle = document.createElement('span');
        handle.className = RESIZE_HANDLE_CLASSNAME;
        const img = document.createElement('img');
        img.setAttribute('src', node.attrs.src);
        img.setAttribute('alt', (_a = node.attrs.alt) !== null && _a !== void 0 ? _a : '');
        img.setAttribute('title', (_b = node.attrs.title) !== null && _b !== void 0 ? _b : '');
        img.style.width = '100%';
        img.style.height = '100%';
        const handleBottomRight = createHandle('BR');
        const handleTopRight = createHandle('TL');
        const handleTopLeft = createHandle('TR');
        const handleBottomLeft = createHandle('BL');
        const resizePropoptionally = (evt) => {
            evt.preventDefault();
            const { state, dispatch } = view;
            const { tr } = state;
            const startX = evt.pageX;
            const startWidth = img.clientWidth;
            const { width } = window.getComputedStyle(view.dom);
            const editorWidth = parseInt(width, 10);
            const onMouseMove = (e) => {
                const currentX = e.pageX;
                const diffInPx = currentX - startX;
                const computedWidth = startWidth + diffInPx;
                // prevent image overflow the editor
                // prevent resizng below 20px
                if (computedWidth > editorWidth || computedWidth < 20) {
                    return;
                }
                outer.style.width = `${computedWidth}px`;
            };
            const onMouseUp = (e) => {
                e.preventDefault();
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                const transaction = tr.setNodeMarkup(getPos(), undefined, {
                    src: node.attrs.src,
                    width: outer.style.width
                });
                const resolvedPos = transaction.doc.resolve(getPos());
                const newSelection = new NodeSelection(resolvedPos);
                transaction.setSelection(newSelection);
                dispatch(transaction);
            };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        };
        handleBottomRight.addEventListener('mousedown', resizePropoptionally, { once: true });
        handleTopRight.addEventListener('mousedown', resizePropoptionally, { once: true });
        handleTopLeft.addEventListener('mousedown', resizePropoptionally, { once: true });
        handleBottomLeft.addEventListener('mousedown', resizePropoptionally, { once: true });
        handle.appendChild(handleBottomRight);
        handle.appendChild(handleTopRight);
        handle.appendChild(handleTopLeft);
        handle.appendChild(handleBottomLeft);
        outer.appendChild(handle);
        outer.appendChild(img);
        this.dom = outer;
        this.img = img;
        this.handle = handle;
    }
    selectNode() {
        this.dom.classList.add(WRAPPER_RESIZE_ACTIVE_CLASSNAME);
        this.handle.style.display = 'block';
    }
    deselectNode() {
        this.dom.classList.remove(WRAPPER_RESIZE_ACTIVE_CLASSNAME);
        this.handle.style.display = 'none';
    }
}
const defaultOptions = {
    resize: true,
};
const imagePlugin = (opts = defaultOptions) => {
    const options = Object.assign(Object.assign({}, defaultOptions), opts);
    return new Plugin({
        key: new PluginKey('link'),
        props: {
            nodeViews: {
                image: (node, view, getPos) => {
                    if (!options.resize) {
                        return null;
                    }
                    return new ImageRezieView(node, view, getPos);
                },
            }
        }
    });
};
const ɵ1 = imagePlugin;
export default imagePlugin;
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcGx1Z2lucy9pbWFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUdyRSxNQUFNLGlCQUFpQixHQUFHLHlCQUF5QixDQUFDO0FBQ3BELE1BQU0sK0JBQStCLEdBQUcsNEJBQTRCLENBQUM7QUFDckUsTUFBTSx1QkFBdUIsR0FBRyx5QkFBeUIsQ0FBQztBQUUxRCxNQUFNLFlBQVksR0FBRyxDQUFDLFNBQWlCLEVBQWUsRUFBRTtJQUN0RCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzlDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsR0FBRyx1QkFBdUIsS0FBSyxTQUFTLEVBQUUsQ0FBQztJQUM5RCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUM7O0FBRUYsTUFBTSxjQUFjO0lBS2xCLFlBQVksSUFBcUIsRUFBRSxJQUFnQixFQUFFLE1BQW9COztRQUN2RSxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdDLEtBQUssQ0FBQyxTQUFTLEdBQUcsaUJBQWlCLENBQUM7UUFDcEMsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFFckMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5QyxNQUFNLENBQUMsU0FBUyxHQUFHLHVCQUF1QixDQUFDO1FBRTNDLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN4QyxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssUUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsbUNBQUksRUFBRSxDQUFDLENBQUM7UUFDOUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxPQUFPLFFBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLG1DQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztRQUN6QixHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFMUIsTUFBTSxpQkFBaUIsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0MsTUFBTSxjQUFjLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFDLE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QyxNQUFNLGdCQUFnQixHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU1QyxNQUFNLG9CQUFvQixHQUFHLENBQUMsR0FBZSxFQUFFLEVBQUU7WUFDL0MsR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBRXJCLE1BQU0sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDO1lBQ2pDLE1BQU0sRUFBRSxFQUFFLEVBQUUsR0FBRyxLQUFLLENBQUM7WUFFckIsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQztZQUN6QixNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsV0FBVyxDQUFDO1lBRW5DLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFFeEMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFhLEVBQUUsRUFBRTtnQkFDcEMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztnQkFDekIsTUFBTSxRQUFRLEdBQUcsUUFBUSxHQUFHLE1BQU0sQ0FBQztnQkFDbkMsTUFBTSxhQUFhLEdBQUcsVUFBVSxHQUFHLFFBQVEsQ0FBQztnQkFFNUMsb0NBQW9DO2dCQUNwQyw2QkFBNkI7Z0JBQzdCLElBQUksYUFBYSxHQUFHLFdBQVcsSUFBSSxhQUFhLEdBQUcsRUFBRSxFQUFFO29CQUNyRCxPQUFPO2lCQUNSO2dCQUVELEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLEdBQUcsYUFBYSxJQUFJLENBQUM7WUFDM0MsQ0FBQyxDQUFDO1lBRUYsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFhLEVBQUUsRUFBRTtnQkFDbEMsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUVuQixRQUFRLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUN2RCxRQUFRLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUVuRCxNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxFQUFFLFNBQVMsRUFBRTtvQkFDeEQsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRztvQkFDbkIsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSztpQkFDekIsQ0FBQyxDQUFDO2dCQUVILE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sWUFBWSxHQUFHLElBQUksYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUVwRCxXQUFXLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUN2QyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUFDO1lBRUYsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUNwRCxRQUFRLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQztRQUVGLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxvQkFBb0IsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3RGLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsb0JBQW9CLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNuRixhQUFhLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLG9CQUFvQixFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDbEYsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLG9CQUFvQixFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFFckYsTUFBTSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDbkMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNsQyxNQUFNLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFckMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxQixLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXZCLElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDdkIsQ0FBQztJQUVELFVBQVU7UUFDUixJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsK0JBQStCLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxZQUFZO1FBQ1YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLCtCQUErQixDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUNyQyxDQUFDO0NBQ0Y7QUFFRCxNQUFNLGNBQWMsR0FBRztJQUNyQixNQUFNLEVBQUUsSUFBSTtDQUNiLENBQUM7QUFFRixNQUFNLFdBQVcsR0FBRyxDQUFDLElBQUksR0FBRyxjQUFjLEVBQVUsRUFBRTtJQUNwRCxNQUFNLE9BQU8sbUNBQVEsY0FBYyxHQUFLLElBQUksQ0FBRSxDQUFDO0lBRS9DLE9BQU8sSUFBSSxNQUFNLENBQUM7UUFDaEIsR0FBRyxFQUFFLElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQztRQUMxQixLQUFLLEVBQUU7WUFDTCxTQUFTLEVBQUU7Z0JBQ1QsS0FBSyxFQUFFLENBQUMsSUFBcUIsRUFBRSxJQUFnQixFQUFFLE1BQW9CLEVBQUUsRUFBRTtvQkFDdkUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7d0JBQ25CLE9BQU8sSUFBSSxDQUFDO3FCQUNiO29CQUNELE9BQU8sSUFBSSxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDaEQsQ0FBQzthQUNGO1NBQ0Y7S0FDRixDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7O0FBRUYsZUFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOb2RlIGFzIFByb3NlbWlycm9yTm9kZSB9IGZyb20gJ3Byb3NlbWlycm9yLW1vZGVsJztcbmltcG9ydCB7IE5vZGVTZWxlY3Rpb24sIFBsdWdpbiwgUGx1Z2luS2V5IH0gZnJvbSAncHJvc2VtaXJyb3Itc3RhdGUnO1xuaW1wb3J0IHsgRWRpdG9yVmlldyB9IGZyb20gJ3Byb3NlbWlycm9yLXZpZXcnO1xuXG5jb25zdCBXUkFQUEVSX0NMQVNTTkFNRSA9ICdOZ3hFZGl0b3JfX0ltYWdlV3JhcHBlcic7XG5jb25zdCBXUkFQUEVSX1JFU0laRV9BQ1RJVkVfQ0xBU1NOQU1FID0gJ05neEVkaXRvcl9fUmVzaXplci0tQWN0aXZlJztcbmNvbnN0IFJFU0laRV9IQU5ETEVfQ0xBU1NOQU1FID0gJ05neEVkaXRvcl9fUmVzaXplSGFuZGxlJztcblxuY29uc3QgY3JlYXRlSGFuZGxlID0gKGRpcmVjdGlvbjogc3RyaW5nKTogSFRNTEVsZW1lbnQgPT4ge1xuICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gIGhhbmRsZS5jbGFzc05hbWUgPSBgJHtSRVNJWkVfSEFORExFX0NMQVNTTkFNRX0tLSR7ZGlyZWN0aW9ufWA7XG4gIHJldHVybiBoYW5kbGU7XG59O1xuXG5jbGFzcyBJbWFnZVJlemllVmlldyB7XG4gIGltZzogSFRNTEVsZW1lbnQ7XG4gIGRvbTogSFRNTEVsZW1lbnQ7XG4gIGhhbmRsZTogSFRNTEVsZW1lbnQ7XG5cbiAgY29uc3RydWN0b3Iobm9kZTogUHJvc2VtaXJyb3JOb2RlLCB2aWV3OiBFZGl0b3JWaWV3LCBnZXRQb3M6ICgpID0+IG51bWJlcikge1xuICAgIGNvbnN0IG91dGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgIG91dGVyLmNsYXNzTmFtZSA9IFdSQVBQRVJfQ0xBU1NOQU1FO1xuICAgIG91dGVyLnN0eWxlLndpZHRoID0gbm9kZS5hdHRycy53aWR0aDtcblxuICAgIGNvbnN0IGhhbmRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbiAgICBoYW5kbGUuY2xhc3NOYW1lID0gUkVTSVpFX0hBTkRMRV9DTEFTU05BTUU7XG5cbiAgICBjb25zdCBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcbiAgICBpbWcuc2V0QXR0cmlidXRlKCdzcmMnLCBub2RlLmF0dHJzLnNyYyk7XG4gICAgaW1nLnNldEF0dHJpYnV0ZSgnYWx0Jywgbm9kZS5hdHRycy5hbHQgPz8gJycpO1xuICAgIGltZy5zZXRBdHRyaWJ1dGUoJ3RpdGxlJywgbm9kZS5hdHRycy50aXRsZSA/PyAnJyk7XG4gICAgaW1nLnN0eWxlLndpZHRoID0gJzEwMCUnO1xuICAgIGltZy5zdHlsZS5oZWlnaHQgPSAnMTAwJSc7XG5cbiAgICBjb25zdCBoYW5kbGVCb3R0b21SaWdodCA9IGNyZWF0ZUhhbmRsZSgnQlInKTtcbiAgICBjb25zdCBoYW5kbGVUb3BSaWdodCA9IGNyZWF0ZUhhbmRsZSgnVEwnKTtcbiAgICBjb25zdCBoYW5kbGVUb3BMZWZ0ID0gY3JlYXRlSGFuZGxlKCdUUicpO1xuICAgIGNvbnN0IGhhbmRsZUJvdHRvbUxlZnQgPSBjcmVhdGVIYW5kbGUoJ0JMJyk7XG5cbiAgICBjb25zdCByZXNpemVQcm9wb3B0aW9uYWxseSA9IChldnQ6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICBjb25zdCB7IHN0YXRlLCBkaXNwYXRjaCB9ID0gdmlldztcbiAgICAgIGNvbnN0IHsgdHIgfSA9IHN0YXRlO1xuXG4gICAgICBjb25zdCBzdGFydFggPSBldnQucGFnZVg7XG4gICAgICBjb25zdCBzdGFydFdpZHRoID0gaW1nLmNsaWVudFdpZHRoO1xuXG4gICAgICBjb25zdCB7IHdpZHRoIH0gPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh2aWV3LmRvbSk7XG4gICAgICBjb25zdCBlZGl0b3JXaWR0aCA9IHBhcnNlSW50KHdpZHRoLCAxMCk7XG5cbiAgICAgIGNvbnN0IG9uTW91c2VNb3ZlID0gKGU6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgY3VycmVudFggPSBlLnBhZ2VYO1xuICAgICAgICBjb25zdCBkaWZmSW5QeCA9IGN1cnJlbnRYIC0gc3RhcnRYO1xuICAgICAgICBjb25zdCBjb21wdXRlZFdpZHRoID0gc3RhcnRXaWR0aCArIGRpZmZJblB4O1xuXG4gICAgICAgIC8vIHByZXZlbnQgaW1hZ2Ugb3ZlcmZsb3cgdGhlIGVkaXRvclxuICAgICAgICAvLyBwcmV2ZW50IHJlc2l6bmcgYmVsb3cgMjBweFxuICAgICAgICBpZiAoY29tcHV0ZWRXaWR0aCA+IGVkaXRvcldpZHRoIHx8IGNvbXB1dGVkV2lkdGggPCAyMCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIG91dGVyLnN0eWxlLndpZHRoID0gYCR7Y29tcHV0ZWRXaWR0aH1weGA7XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBvbk1vdXNlVXAgPSAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgb25Nb3VzZU1vdmUpO1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgb25Nb3VzZVVwKTtcblxuICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRyLnNldE5vZGVNYXJrdXAoZ2V0UG9zKCksIHVuZGVmaW5lZCwge1xuICAgICAgICAgIHNyYzogbm9kZS5hdHRycy5zcmMsXG4gICAgICAgICAgd2lkdGg6IG91dGVyLnN0eWxlLndpZHRoXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHJlc29sdmVkUG9zID0gdHJhbnNhY3Rpb24uZG9jLnJlc29sdmUoZ2V0UG9zKCkpO1xuICAgICAgICBjb25zdCBuZXdTZWxlY3Rpb24gPSBuZXcgTm9kZVNlbGVjdGlvbihyZXNvbHZlZFBvcyk7XG5cbiAgICAgICAgdHJhbnNhY3Rpb24uc2V0U2VsZWN0aW9uKG5ld1NlbGVjdGlvbik7XG4gICAgICAgIGRpc3BhdGNoKHRyYW5zYWN0aW9uKTtcbiAgICAgIH07XG5cbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uTW91c2VNb3ZlKTtcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBvbk1vdXNlVXApO1xuICAgIH07XG5cbiAgICBoYW5kbGVCb3R0b21SaWdodC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCByZXNpemVQcm9wb3B0aW9uYWxseSwgeyBvbmNlOiB0cnVlIH0pO1xuICAgIGhhbmRsZVRvcFJpZ2h0LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHJlc2l6ZVByb3BvcHRpb25hbGx5LCB7IG9uY2U6IHRydWUgfSk7XG4gICAgaGFuZGxlVG9wTGVmdC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCByZXNpemVQcm9wb3B0aW9uYWxseSwgeyBvbmNlOiB0cnVlIH0pO1xuICAgIGhhbmRsZUJvdHRvbUxlZnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgcmVzaXplUHJvcG9wdGlvbmFsbHksIHsgb25jZTogdHJ1ZSB9KTtcblxuICAgIGhhbmRsZS5hcHBlbmRDaGlsZChoYW5kbGVCb3R0b21SaWdodCk7XG4gICAgaGFuZGxlLmFwcGVuZENoaWxkKGhhbmRsZVRvcFJpZ2h0KTtcbiAgICBoYW5kbGUuYXBwZW5kQ2hpbGQoaGFuZGxlVG9wTGVmdCk7XG4gICAgaGFuZGxlLmFwcGVuZENoaWxkKGhhbmRsZUJvdHRvbUxlZnQpO1xuXG4gICAgb3V0ZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTtcbiAgICBvdXRlci5hcHBlbmRDaGlsZChpbWcpO1xuXG4gICAgdGhpcy5kb20gPSBvdXRlcjtcbiAgICB0aGlzLmltZyA9IGltZztcbiAgICB0aGlzLmhhbmRsZSA9IGhhbmRsZTtcbiAgfVxuXG4gIHNlbGVjdE5vZGUoKTogdm9pZCB7XG4gICAgdGhpcy5kb20uY2xhc3NMaXN0LmFkZChXUkFQUEVSX1JFU0laRV9BQ1RJVkVfQ0xBU1NOQU1FKTtcbiAgICB0aGlzLmhhbmRsZS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgfVxuXG4gIGRlc2VsZWN0Tm9kZSgpOiB2b2lkIHtcbiAgICB0aGlzLmRvbS5jbGFzc0xpc3QucmVtb3ZlKFdSQVBQRVJfUkVTSVpFX0FDVElWRV9DTEFTU05BTUUpO1xuICAgIHRoaXMuaGFuZGxlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gIH1cbn1cblxuY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gIHJlc2l6ZTogdHJ1ZSxcbn07XG5cbmNvbnN0IGltYWdlUGx1Z2luID0gKG9wdHMgPSBkZWZhdWx0T3B0aW9ucyk6IFBsdWdpbiA9PiB7XG4gIGNvbnN0IG9wdGlvbnMgPSB7IC4uLmRlZmF1bHRPcHRpb25zLCAuLi5vcHRzIH07XG5cbiAgcmV0dXJuIG5ldyBQbHVnaW4oe1xuICAgIGtleTogbmV3IFBsdWdpbktleSgnbGluaycpLFxuICAgIHByb3BzOiB7XG4gICAgICBub2RlVmlld3M6IHtcbiAgICAgICAgaW1hZ2U6IChub2RlOiBQcm9zZW1pcnJvck5vZGUsIHZpZXc6IEVkaXRvclZpZXcsIGdldFBvczogKCkgPT4gbnVtYmVyKSA9PiB7XG4gICAgICAgICAgaWYgKCFvcHRpb25zLnJlc2l6ZSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBuZXcgSW1hZ2VSZXppZVZpZXcobm9kZSwgdmlldywgZ2V0UG9zKTtcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgaW1hZ2VQbHVnaW47XG4iXX0=