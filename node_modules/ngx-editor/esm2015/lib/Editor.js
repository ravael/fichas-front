import { EditorState } from 'prosemirror-state';
import { EditorView } from 'prosemirror-view';
import { Subject } from 'rxjs';
import { editable as editablePlugin, placeholder as placeholderPlugin } from 'ngx-editor/plugins';
import { isNil } from 'ngx-editor/utils';
import EditorCommands from './EditorCommands';
import defautlSchema from './schema';
import { parseContent } from './parsers';
import getDefaultPlugins from './defaultPlugins';
const DEFAULT_OPTIONS = {
    content: null,
    enabled: true,
    history: true,
    keyboardShortcuts: true,
    inputRules: true,
    schema: defautlSchema,
    plugins: [],
    nodeViews: {}
};
class Editor {
    constructor(options = DEFAULT_OPTIONS) {
        this.onContentChange = new Subject();
        this.onFocus = new Subject();
        this.onBlur = new Subject();
        this.onUpdate = new Subject();
        this.options = Object.assign({}, DEFAULT_OPTIONS, options);
        this.createEditor();
    }
    get schema() {
        return this.options.schema || defautlSchema;
    }
    get commands() {
        return new EditorCommands(this.view);
    }
    setContent(content) {
        if (isNil(content)) {
            return;
        }
        const { state } = this.view;
        const { tr, doc } = state;
        const newDoc = parseContent(content, this.schema);
        tr.replaceWith(0, state.doc.content.size, newDoc);
        // don't emit if both content is same
        if (doc.eq(tr.doc)) {
            return;
        }
        if (!tr.docChanged) {
            return;
        }
        this.view.dispatch(tr);
    }
    handleTransactions(tr) {
        const state = this.view.state.apply(tr);
        this.view.updateState(state);
        this.onUpdate.next();
        if (!tr.docChanged && !tr.getMeta('FORCE_EMIT')) {
            return;
        }
        const json = state.doc.toJSON();
        this.onContentChange.next(json);
    }
    createEditor() {
        var _a, _b;
        const { options } = this;
        const { content = null, nodeViews, enabled } = options;
        const { history = true, keyboardShortcuts = true, inputRules = true } = options;
        const schema = this.schema;
        const editable = enabled !== null && enabled !== void 0 ? enabled : true;
        const placeholder = (_a = options.placeholder) !== null && _a !== void 0 ? _a : '';
        const doc = parseContent(content, schema);
        this.el = document.createDocumentFragment();
        const plugins = [
            editablePlugin(),
            placeholderPlugin(placeholder),
            ...((_b = options.plugins) !== null && _b !== void 0 ? _b : [])
        ];
        const defaultPlugins = getDefaultPlugins(schema, {
            history,
            keyboardShortcuts,
            inputRules
        });
        plugins.push(...defaultPlugins);
        this.view = new EditorView(this.el, {
            editable: () => editable,
            state: EditorState.create({
                doc,
                schema,
                plugins,
            }),
            nodeViews,
            dispatchTransaction: this.handleTransactions.bind(this),
            handleDOMEvents: {
                focus: () => {
                    this.onFocus.next();
                    return false;
                },
                blur: () => {
                    this.onBlur.next();
                    return false;
                }
            },
            attributes: {
                class: 'NgxEditor__Content'
            },
        });
    }
    registerPlugin(plugin) {
        const { state } = this.view;
        const plugins = [...state.plugins, plugin];
        const newState = state.reconfigure({ plugins });
        this.view.updateState(newState);
    }
    enable() {
        const { dispatch, state: { tr } } = this.view;
        dispatch(tr.setMeta('UPDATE_EDITABLE', true));
    }
    disable() {
        const { dispatch, state: { tr } } = this.view;
        dispatch(tr.setMeta('UPDATE_EDITABLE', false));
    }
    setPlaceholder(placeholder) {
        const { dispatch, state: { tr } } = this.view;
        dispatch(tr.setMeta('UPDATE_PLACEHOLDER', placeholder));
    }
    destroy() {
        this.view.destroy();
    }
}
export default Editor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9FZGl0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFdBQVcsRUFBdUIsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRSxPQUFPLEVBQWUsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDM0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixPQUFPLEVBQ0wsUUFBUSxJQUFJLGNBQWMsRUFDMUIsV0FBVyxJQUFJLGlCQUFpQixFQUNqQyxNQUFNLG9CQUFvQixDQUFDO0FBQzVCLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUV6QyxPQUFPLGNBQWMsTUFBTSxrQkFBa0IsQ0FBQztBQUM5QyxPQUFPLGFBQWEsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN6QyxPQUFPLGlCQUFpQixNQUFNLGtCQUFrQixDQUFDO0FBaUJqRCxNQUFNLGVBQWUsR0FBWTtJQUMvQixPQUFPLEVBQUUsSUFBSTtJQUNiLE9BQU8sRUFBRSxJQUFJO0lBQ2IsT0FBTyxFQUFFLElBQUk7SUFDYixpQkFBaUIsRUFBRSxJQUFJO0lBQ3ZCLFVBQVUsRUFBRSxJQUFJO0lBQ2hCLE1BQU0sRUFBRSxhQUFhO0lBQ3JCLE9BQU8sRUFBRSxFQUFFO0lBQ1gsU0FBUyxFQUFFLEVBQUU7Q0FDZCxDQUFDO0FBRUYsTUFBTSxNQUFNO0lBVVYsWUFBWSxVQUFtQixlQUFlO1FBTDlDLG9CQUFlLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUN6QyxZQUFPLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUM5QixXQUFNLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUM3QixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUd2QixJQUFJLENBQUMsT0FB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LENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsTUFBTTtRQUNKLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQzlDLFFBQVEsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVELE9BQU87UUFDTCxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUM5QyxRQUFRLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxjQUFjLENBQUMsV0FBbUI7UUFDaEMsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDOUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsb0JBQW9CLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRUQsT0FBTztRQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBRUQsZUFBZSxNQUFNLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTY2hlbWEgfSBmcm9tICdwcm9zZW1pcnJvci1tb2RlbCc7XG5pbXBvcnQgeyBFZGl0b3JTdGF0ZSwgUGx1Z2luLCBUcmFuc2FjdGlvbiB9IGZyb20gJ3Byb3NlbWlycm9yLXN0YXRlJztcbmltcG9ydCB7IEVkaXRvclByb3BzLCBFZGl0b3JWaWV3IH0gZnJvbSAncHJvc2VtaXJyb3Itdmlldyc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7XG4gIGVkaXRhYmxlIGFzIGVkaXRhYmxlUGx1Z2luLFxuICBwbGFjZWhvbGRlciBhcyBwbGFjZWhvbGRlclBsdWdpblxufSBmcm9tICduZ3gtZWRpdG9yL3BsdWdpbnMnO1xuaW1wb3J0IHsgaXNOaWwgfSBmcm9tICduZ3gtZWRpdG9yL3V0aWxzJztcblxuaW1wb3J0IEVkaXRvckNvbW1hbmRzIGZyb20gJy4vRWRpdG9yQ29tbWFuZHMnO1xuaW1wb3J0IGRlZmF1dGxTY2hlbWEgZnJvbSAnLi9zY2hlbWEnO1xuaW1wb3J0IHsgcGFyc2VDb250ZW50IH0gZnJvbSAnLi9wYXJzZXJzJztcbmltcG9ydCBnZXREZWZhdWx0UGx1Z2lucyBmcm9tICcuL2RlZmF1bHRQbHVnaW5zJztcblxudHlwZSBDb250ZW50ID0gc3RyaW5nIHwgUmVjb3JkPHN0cmluZywgYW55PiB8IG51bGw7XG50eXBlIEpTT05Eb2MgPSBSZWNvcmQ8c3RyaW5nLCBudWxsPjtcblxuaW50ZXJmYWNlIE9wdGlvbnMge1xuICBjb250ZW50PzogQ29udGVudDtcbiAgZW5hYmxlZD86IGJvb2xlYW47XG4gIHBsYWNlaG9sZGVyPzogc3RyaW5nO1xuICBoaXN0b3J5PzogYm9vbGVhbjtcbiAga2V5Ym9hcmRTaG9ydGN1dHM/OiBib29sZWFuO1xuICBpbnB1dFJ1bGVzPzogYm9vbGVhbjtcbiAgc2NoZW1hPzogU2NoZW1hO1xuICBwbHVnaW5zPzogUGx1Z2luW107XG4gIG5vZGVWaWV3cz86IEVkaXRvclByb3BzWydub2RlVmlld3MnXTtcbn1cblxuY29uc3QgREVGQVVMVF9PUFRJT05TOiBPcHRpb25zID0ge1xuICBjb250ZW50OiBudWxsLFxuICBlbmFibGVkOiB0cnVlLFxuICBoaXN0b3J5OiB0cnVlLFxuICBrZXlib2FyZFNob3J0Y3V0czogdHJ1ZSxcbiAgaW5wdXRSdWxlczogdHJ1ZSxcbiAgc2NoZW1hOiBkZWZhdXRsU2NoZW1hLFxuICBwbHVnaW5zOiBbXSxcbiAgbm9kZVZpZXdzOiB7fVxufTtcblxuY2xhc3MgRWRpdG9yIHtcbiAgdmlldzogRWRpdG9yVmlldztcbiAgb3B0aW9uczogT3B0aW9ucztcbiAgZWw6IERvY3VtZW50RnJhZ21lbnQ7XG5cbiAgb25Db250ZW50Q2hhbmdlID0gbmV3IFN1YmplY3Q8SlNPTkRvYz4oKTtcbiAgb25Gb2N1cyA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIG9uQmx1ciA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIG9uVXBkYXRlID0gbmV3IFN1YmplY3QoKTtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBPcHRpb25zID0gREVGQVVMVF9PUFRJT05TKSB7XG4gICAgdGhpcy5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9PUFRJT05TLCBvcHRpb25zKTtcbiAgICB0aGlzLmNyZWF0ZUVkaXRvcigpO1xuICB9XG5cbiAgZ2V0IHNjaGVtYSgpOiBTY2hlbWEge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMuc2NoZW1hIHx8IGRlZmF1dGxTY2hlbWE7XG4gIH1cblxuICBnZXQgY29tbWFuZHMoKTogRWRpdG9yQ29tbWFuZHMge1xuICAgIHJldHVybiBuZXcgRWRpdG9yQ29tbWFuZHModGhpcy52aWV3KTtcbiAgfVxuXG4gIHNldENvbnRlbnQoY29udGVudDogQ29udGVudCk6IHZvaWQge1xuICAgIGlmIChpc05pbChjb250ZW50KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHsgc3RhdGUgfSA9IHRoaXMudmlldztcbiAgICBjb25zdCB7IHRyLCBkb2MgfSA9IHN0YXRlO1xuXG4gICAgY29uc3QgbmV3RG9jID0gcGFyc2VDb250ZW50KGNvbnRlbnQsIHRoaXMuc2NoZW1hKTtcblxuICAgIHRyLnJlcGxhY2VXaXRoKDAsIHN0YXRlLmRvYy5jb250ZW50LnNpemUsIG5ld0RvYyk7XG5cbiAgICAvLyBkb24ndCBlbWl0IGlmIGJvdGggY29udGVudCBpcyBzYW1lXG4gICAgaWYgKGRvYy5lcSh0ci5kb2MpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0ci5kb2NDaGFuZ2VkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy52aWV3LmRpc3BhdGNoKHRyKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlVHJhbnNhY3Rpb25zKHRyOiBUcmFuc2FjdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy52aWV3LnN0YXRlLmFwcGx5KHRyKTtcbiAgICB0aGlzLnZpZXcudXBkYXRlU3RhdGUoc3RhdGUpO1xuXG4gICAgdGhpcy5vblVwZGF0ZS5uZXh0KCk7XG5cbiAgICBpZiAoIXRyLmRvY0NoYW5nZWQgJiYgIXRyLmdldE1ldGEoJ0ZPUkNFX0VNSVQnKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGpzb24gPSBzdGF0ZS5kb2MudG9KU09OKCk7XG4gICAgdGhpcy5vbkNvbnRlbnRDaGFuZ2UubmV4dChqc29uKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRWRpdG9yKCk6IHZvaWQge1xuICAgIGNvbnN0IHsgb3B0aW9ucyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGNvbnRlbnQgPSBudWxsLCBub2RlVmlld3MsIGVuYWJsZWQgfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgeyBoaXN0b3J5ID0gdHJ1ZSwga2V5Ym9hcmRTaG9ydGN1dHMgPSB0cnVlLCBpbnB1dFJ1bGVzID0gdHJ1ZSB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBzY2hlbWEgPSB0aGlzLnNjaGVtYTtcblxuICAgIGNvbnN0IGVkaXRhYmxlID0gZW5hYmxlZCA/PyB0cnVlO1xuICAgIGNvbnN0IHBsYWNlaG9sZGVyID0gb3B0aW9ucy5wbGFjZWhvbGRlciA/PyAnJztcblxuICAgIGNvbnN0IGRvYyA9IHBhcnNlQ29udGVudChjb250ZW50LCBzY2hlbWEpO1xuICAgIHRoaXMuZWwgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG5cbiAgICBjb25zdCBwbHVnaW5zOiBQbHVnaW5bXSA9IFtcbiAgICAgIGVkaXRhYmxlUGx1Z2luKCksXG4gICAgICBwbGFjZWhvbGRlclBsdWdpbihwbGFjZWhvbGRlciksXG4gICAgICAuLi4ob3B0aW9ucy5wbHVnaW5zID8/IFtdKVxuICAgIF07XG5cbiAgICBjb25zdCBkZWZhdWx0UGx1Z2lucyA9IGdldERlZmF1bHRQbHVnaW5zKHNjaGVtYSwge1xuICAgICAgaGlzdG9yeSxcbiAgICAgIGtleWJvYXJkU2hvcnRjdXRzLFxuICAgICAgaW5wdXRSdWxlc1xuICAgIH0pO1xuXG4gICAgcGx1Z2lucy5wdXNoKC4uLmRlZmF1bHRQbHVnaW5zKTtcblxuICAgIHRoaXMudmlldyA9IG5ldyBFZGl0b3JWaWV3KHRoaXMuZWwsIHtcbiAgICAgIGVkaXRhYmxlOiAoKSA9PiBlZGl0YWJsZSxcbiAgICAgIHN0YXRlOiBFZGl0b3JTdGF0ZS5jcmVhdGUoe1xuICAgICAgICBkb2MsXG4gICAgICAgIHNjaGVtYSxcbiAgICAgICAgcGx1Z2lucyxcbiAgICAgIH0pLFxuICAgICAgbm9kZVZpZXdzLFxuICAgICAgZGlzcGF0Y2hUcmFuc2FjdGlvbjogdGhpcy5oYW5kbGVUcmFuc2FjdGlvbnMuYmluZCh0aGlzKSxcbiAgICAgIGhhbmRsZURPTUV2ZW50czoge1xuICAgICAgICBmb2N1czogKCkgPT4ge1xuICAgICAgICAgIHRoaXMub25Gb2N1cy5uZXh0KCk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9LFxuICAgICAgICBibHVyOiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5vbkJsdXIubmV4dCgpO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGF0dHJpYnV0ZXM6IHtcbiAgICAgICAgY2xhc3M6ICdOZ3hFZGl0b3JfX0NvbnRlbnQnXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcmVnaXN0ZXJQbHVnaW4ocGx1Z2luOiBQbHVnaW4pOiB2b2lkIHtcbiAgICBjb25zdCB7IHN0YXRlIH0gPSB0aGlzLnZpZXc7XG4gICAgY29uc3QgcGx1Z2lucyA9IFsuLi5zdGF0ZS5wbHVnaW5zLCBwbHVnaW5dO1xuXG4gICAgY29uc3QgbmV3U3RhdGUgPSBzdGF0ZS5yZWNvbmZpZ3VyZSh7IHBsdWdpbnMgfSk7XG4gICAgdGhpcy52aWV3LnVwZGF0ZVN0YXRlKG5ld1N0YXRlKTtcbiAgfVxuXG4gIGVuYWJsZSgpOiB2b2lkIHtcbiAgICBjb25zdCB7IGRpc3BhdGNoLCBzdGF0ZTogeyB0ciB9IH0gPSB0aGlzLnZpZXc7XG4gICAgZGlzcGF0Y2godHIuc2V0TWV0YSgnVVBEQVRFX0VESVRBQkxFJywgdHJ1ZSkpO1xuICB9XG5cbiAgZGlzYWJsZSgpOiB2b2lkIHtcbiAgICBjb25zdCB7IGRpc3BhdGNoLCBzdGF0ZTogeyB0ciB9IH0gPSB0aGlzLnZpZXc7XG4gICAgZGlzcGF0Y2godHIuc2V0TWV0YSgnVVBEQVRFX0VESVRBQkxFJywgZmFsc2UpKTtcbiAgfVxuXG4gIHNldFBsYWNlaG9sZGVyKHBsYWNlaG9sZGVyOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCB7IGRpc3BhdGNoLCBzdGF0ZTogeyB0ciB9IH0gPSB0aGlzLnZpZXc7XG4gICAgZGlzcGF0Y2godHIuc2V0TWV0YSgnVVBEQVRFX1BMQUNFSE9MREVSJywgcGxhY2Vob2xkZXIpKTtcbiAgfVxuXG4gIGRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy52aWV3LmRlc3Ryb3koKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBFZGl0b3I7XG4iXX0=